---

# Steps you need to do before run this

# 1) Install moon in your cluster: git clone https://github.com/aerokube/moon-deploy.git && cd moon-deploy && kubectl apply -f moon.yaml
# Run this poc: kubectl apply -f k8s-poc.yml
# Check pods results

# kubectl create deployment calculator-app --image=docker.io/alex2357/etsdemocalculatornet -o yaml --dry-run=client
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: calculator-app
  name: calculator-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: calculator-app
  strategy: { }
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: calculator-app
    spec:
      containers:
        - image: docker.io/alex2357/etsdemocalculatornet
          name: etsdemocalculatornet
          resources: { }
          imagePullPolicy: IfNotPresent
status: { }

---
# mkctl create service clusterip calculatorappsvc --tcp=8080:8080 -o yaml --dry-run=client

apiVersion: v1
kind: Service
metadata:
  creationTimestamp: null
  labels:
    app: calculator-app
  name: calculatorappsvc
spec:
  ports:
    - name: 8080-8080
      port: 8080
      protocol: TCP
      targetPort: 8080
  selector:
    app: calculator-app
  type: ClusterIP
status:
  loadBalancer: { }

---

#  mkctl create configmap testrunsettings --from-file=k8s.runsettings -o yaml --dry-run=client

apiVersion: v1
data:
  k8s-runsettings: "\uFEFF\x3C\x3F\x78\x6D\x6C\x20\x76\x65\x72\x73\x69\x6F\x6E\x3D\"\x31\x2E\x30\"\x20\x65\x6E\x63\x6F\x64\x69\x6E\x67\x3D\"\x75\x74\x66\x2D\x38\"\x3F\x3E\n\n\x3C\x52\x75\x6E\x53\x65\x74\x74\x69\x6E\x67\x73\x3E\n\x20\x20\x3C\x21\x2D\x2D\x20\x43\x6F\x6E\x66\x69\x67\x75\x72\x61\x74\x69\x6F\x6E\x73\x20\x74\x68\x61\x74\x20\x61\x66\x66\x65\x63\x74\x20\x74\x68\x65\x20\x54\x65\x73\x74\x20\x46\x72\x61\x6D\x65\x77\x6F\x72\x6B\x20\x2D\x2D\x3E\n\x20\x20\x3C\x52\x75\x6E\x43\x6F\x6E\x66\x69\x67\x75\x72\x61\x74\x69\x6F\x6E\x3E\n\x20\x20\x20\x20\x3C\x21\x2D\x2D\x20\x50\x61\x74\x68\x20\x72\x65\x6C\x61\x74\x69\x76\x65\x20\x74\x6F\x20\x73\x6F\x6C\x75\x74\x69\x6F\x6E\x20\x64\x69\x72\x65\x63\x74\x6F\x72\x79\x20\x2D\x2D\x3E\n\x20\x20\x20\x20\x3C\x52\x65\x73\x75\x6C\x74\x73\x44\x69\x72\x65\x63\x74\x6F\x72\x79\x3E\x2F\x74\x6D\x70\x2F\x74\x65\x73\x74\x72\x75\x6E\x72\x65\x73\x75\x6C\x74\x73\x3C\x2F\x52\x65\x73\x75\x6C\x74\x73\x44\x69\x72\x65\x63\x74\x6F\x72\x79\x3E\n\x20\x20\x20\x20\x3C\x21\x2D\x2D\x20\x5B\x78\x38\x36\x5D\x20\x7C\x20\x78\x36\x34\x20\x20\x20\x20\x2D\x20\x59\x6F\x75\x20\x63\x61\x6E\x20\x61\x6C\x73\x6F\x20\x63\x68\x61\x6E\x67\x65\x20\x69\x74\x20\x66\x72\x6F\x6D\x20\x6D\x65\x6E\x75\x20\x54\x65\x73\x74\x2C\x20\x54\x65\x73\x74\x20\x53\x65\x74\x74\x69\x6E\x67\x73\x2C\x20\x44\x65\x66\x61\x75\x6C\x74\x20\x50\x72\x6F\x63\x65\x73\x73\x6F\x72\x20\x41\x72\x63\x68\x69\x74\x65\x63\x74\x75\x72\x65\x20\x2D\x2D\x3E\n\x20\x20\x20\x20\x3C\x21\x2D\x2D\x20\x46\x72\x61\x6D\x65\x77\x6F\x72\x6B\x33\x35\x20\x7C\x20\x5B\x46\x72\x61\x6D\x65\x77\x6F\x72\x6B\x34\x30\x5D\x20\x7C\x20\x46\x72\x61\x6D\x65\x77\x6F\x72\x6B\x34\x35\x20\x2D\x2D\x3E\n\x20\x20\x20\x20\x3C\x21\x2D\x2D\x20\x46\x72\x61\x6D\x65\x77\x6F\x72\x6B\x33\x35\x20\x7C\x20\x5B\x46\x72\x61\x6D\x65\x77\x6F\x72\x6B\x34\x30\x5D\x20\x7C\x20\x46\x72\x61\x6D\x65\x77\x6F\x72\x6B\x34\x35\x20\x2D\x2D\x3E\n\x20\x20\x20\x20\x3C\x44\x69\x73\x61\x62\x6C\x65\x50\x61\x72\x61\x6C\x6C\x65\x6C\x69\x7A\x61\x74\x69\x6F\x6E\x3E\x74\x72\x75\x65\x3C\x2F\x44\x69\x73\x61\x62\x6C\x65\x50\x61\x72\x61\x6C\x6C\x65\x6C\x69\x7A\x61\x74\x69\x6F\x6E\x3E\n\x20\x20\x20\x20\x3C\x4D\x61\x78\x43\x70\x75\x43\x6F\x75\x6E\x74\x3E\x36\x3C\x2F\x4D\x61\x78\x43\x70\x75\x43\x6F\x75\x6E\x74\x3E\n\x20\x20\x3C\x2F\x52\x75\x6E\x43\x6F\x6E\x66\x69\x67\x75\x72\x61\x74\x69\x6F\x6E\x3E\n\n\x20\x20\x3C\x54\x65\x73\x74\x52\x75\x6E\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x73\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x4C\x6F\x67\x4C\x65\x76\x65\x6C\"\x20\x76\x61\x6C\x75\x65\x3D\"\x44\x65\x62\x75\x67\"\x20\x2F\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x4C\x6F\x67\x4E\x61\x6D\x65\"\x20\x76\x61\x6C\x75\x65\x3D\"\x57\x65\x62\x54\x65\x73\x74\"\x20\x2F\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x42\x61\x73\x65\x55\x72\x6C\"\x20\x76\x61\x6C\x75\x65\x3D\"\x68\x74\x74\x70\x73\x3A\x2F\x2F\x77\x77\x77\x2E\x67\x6F\x6F\x67\x6C\x65\x2E\x63\x6F\x6D\"\x20\x2F\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x44\x72\x69\x76\x65\x72\x53\x65\x72\x76\x65\x72\x4C\x6F\x63\x61\x74\x69\x6F\x6E\"\x20\x76\x61\x6C\x75\x65\x3D\"\x2E\"\x20\x2F\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x54\x69\x6D\x65\x6F\x75\x74\"\x20\x76\x61\x6C\x75\x65\x3D\"\x31\x30\"\x20\x2F\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x4F\x75\x74\x70\x75\x74\x46\x69\x6C\x65\x44\x69\x72\x65\x63\x74\x6F\x72\x79\"\x20\x76\x61\x6C\x75\x65\x3D\"\x2F\x74\x6D\x70\x2F\x74\x65\x73\x74\x72\x75\x6E\x72\x65\x73\x75\x6C\x74\x73\"\x20\x2F\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x4F\x75\x74\x70\x75\x74\x46\x69\x6C\x65\x53\x63\x72\x65\x65\x6E\x73\x68\x6F\x74\x73\x44\x69\x72\x65\x63\x74\x6F\x72\x79\"\x20\x76\x61\x6C\x75\x65\x3D\"\x2F\x74\x6D\x70\x2F\x74\x65\x73\x74\x72\x75\x6E\x72\x65\x73\x75\x6C\x74\x73\"\x20\x2F\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x4C\x6F\x67\x69\x6E\x57\x61\x69\x74\x54\x69\x6D\x65\"\x20\x76\x61\x6C\x75\x65\x3D\"\x31\"\x20\x2F\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x4E\x61\x76\x69\x67\x61\x74\x65\x54\x6F\x42\x61\x73\x65\x50\x61\x67\x65\"\x20\x76\x61\x6C\x75\x65\x3D\"\x66\x61\x6C\x73\x65\"\x20\x2F\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x46\x6F\x72\x63\x65\x4B\x69\x6C\x6C\x50\x72\x6F\x63\x65\x73\x73\"\x20\x76\x61\x6C\x75\x65\x3D\"\x66\x61\x6C\x73\x65\"\x20\x2F\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x48\x65\x61\x64\x6C\x65\x73\x73\"\x20\x76\x61\x6C\x75\x65\x3D\"\x66\x61\x6C\x73\x65\"\x20\x2F\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x42\x72\x6F\x77\x73\x65\x72\x54\x79\x70\x65\"\x20\x76\x61\x6C\x75\x65\x3D\"\x63\x68\x72\x6F\x6D\x65\"\x20\x2F\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x42\x72\x6F\x77\x73\x65\x72\x50\x72\x6F\x66\x69\x6C\x65\"\x20\x76\x61\x6C\x75\x65\x3D\"\x64\x65\x66\x61\x75\x6C\x74\"\x20\x2F\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x42\x72\x6F\x77\x73\x65\x72\x4F\x73\"\x20\x76\x61\x6C\x75\x65\x3D\"\x4C\x69\x6E\x75\x78\"\x20\x2F\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x45\x6E\x61\x62\x6C\x65\x44\x65\x74\x61\x69\x6C\x65\x64\x4C\x6F\x67\x67\x69\x6E\x67\"\x20\x76\x61\x6C\x75\x65\x3D\"\x66\x61\x6C\x73\x65\"\x20\x2F\x3E\n\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x55\x73\x65\x53\x65\x6C\x65\x6E\x69\x75\x6D\x47\x72\x69\x64\"\x20\x76\x61\x6C\x75\x65\x3D\"\x74\x72\x75\x65\"\x20\x2F\x3E\n\x20\x20\x20\x20\n\x20\x20\x20\x20\x3C\x21\x2D\x2D\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x53\x65\x6C\x65\x6E\x69\x75\x6D\x47\x72\x69\x64\x55\x72\x6C\"\x20\x76\x61\x6C\x75\x65\x3D\"\x68\x74\x74\x70\x3A\x2F\x2F\x73\x65\x6C\x65\x6E\x69\x75\x6D\x2D\x72\x6F\x75\x74\x65\x72\x2D\x64\x65\x70\x6C\x6F\x79\x6D\x65\x6E\x74\x3A\x34\x34\x34\x34\x2F\x77\x64\x2F\x68\x75\x62\"\x20\x2F\x3E\x20\x2D\x2D\x3E\n\x20\x20\x20\x20\x3C\x21\x2D\x2D\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x53\x65\x6C\x65\x6E\x69\x75\x6D\x47\x72\x69\x64\x55\x72\x6C\"\x20\x76\x61\x6C\x75\x65\x3D\"\x68\x74\x74\x70\x3A\x2F\x2F\x73\x65\x6C\x65\x6E\x69\x75\x6D\x2D\x72\x6F\x75\x74\x65\x72\x3A\x34\x34\x34\x34\x2F\x77\x64\x2F\x68\x75\x62\"\x20\x2F\x3E\x20\x2D\x2D\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x53\x65\x6C\x65\x6E\x69\x75\x6D\x47\x72\x69\x64\x55\x72\x6C\"\x20\x76\x61\x6C\x75\x65\x3D\"\x68\x74\x74\x70\x3A\x2F\x2F\x6D\x6F\x6F\x6E\x2E\x6D\x6F\x6F\x6E\x3A\x34\x34\x34\x34\x2F\x77\x64\x2F\x68\x75\x62\"\x20\x2F\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x20\x6E\x61\x6D\x65\x3D\"\x43\x61\x6C\x63\x75\x6C\x61\x74\x6F\x72\x48\x6F\x6D\x65\x50\x61\x67\x65\x55\x72\x6C\"\x20\x76\x61\x6C\x75\x65\x3D\"\x68\x74\x74\x70\x3A\x2F\x2F\x63\x61\x6C\x63\x75\x6C\x61\x74\x6F\x72\x61\x70\x70\x73\x76\x63\x2E\x64\x65\x66\x61\x75\x6C\x74\x3A\x38\x30\x38\x30\"\x20\x2F\x3E\n\n\x20\x20\x3C\x2F\x54\x65\x73\x74\x52\x75\x6E\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x73\x3E\n\x20\x20\x3C\x21\x2D\x2D\x20\x4D\x53\x54\x65\x73\x74\x20\x61\x64\x61\x70\x74\x65\x72\x20\x2D\x2D\x3E\n\x20\x20\x3C\x21\x2D\x2D\x20\x4D\x53\x54\x65\x73\x74\x20\x61\x64\x61\x70\x74\x65\x72\x20\x2D\x2D\x3E\n\n\x20\x20\x3C\x4D\x53\x54\x65\x73\x74\x3E\n\x20\x20\x20\x20\x3C\x50\x61\x72\x61\x6C\x6C\x65\x6C\x69\x7A\x65\x3E\n\x20\x20\x20\x20\x20\x20\x3C\x57\x6F\x72\x6B\x65\x72\x73\x3E\x33\x3C\x2F\x57\x6F\x72\x6B\x65\x72\x73\x3E\n\x20\x20\x20\x20\x20\x20\x3C\x53\x63\x6F\x70\x65\x3E\x4D\x65\x74\x68\x6F\x64\x4C\x65\x76\x65\x6C\x3C\x2F\x53\x63\x6F\x70\x65\x3E\n\x20\x20\x20\x20\x3C\x2F\x50\x61\x72\x61\x6C\x6C\x65\x6C\x69\x7A\x65\x3E\n\x20\x20\x20\x20\x3C\x4D\x61\x70\x49\x6E\x63\x6F\x6E\x63\x6C\x75\x73\x69\x76\x65\x54\x6F\x46\x61\x69\x6C\x65\x64\x3E\x54\x72\x75\x65\x3C\x2F\x4D\x61\x70\x49\x6E\x63\x6F\x6E\x63\x6C\x75\x73\x69\x76\x65\x54\x6F\x46\x61\x69\x6C\x65\x64\x3E\n\x20\x20\x20\x20\x3C\x43\x61\x70\x74\x75\x72\x65\x54\x72\x61\x63\x65\x4F\x75\x74\x70\x75\x74\x3E\x66\x61\x6C\x73\x65\x3C\x2F\x43\x61\x70\x74\x75\x72\x65\x54\x72\x61\x63\x65\x4F\x75\x74\x70\x75\x74\x3E\n\x20\x20\x20\x20\x3C\x44\x65\x6C\x65\x74\x65\x44\x65\x70\x6C\x6F\x79\x6D\x65\x6E\x74\x44\x69\x72\x65\x63\x74\x6F\x72\x79\x41\x66\x74\x65\x72\x54\x65\x73\x74\x52\x75\x6E\x49\x73\x43\x6F\x6D\x70\x6C\x65\x74\x65\x3E\x46\x61\x6C\x73\x65\x3C\x2F\x44\x65\x6C\x65\x74\x65\x44\x65\x70\x6C\x6F\x79\x6D\x65\x6E\x74\x44\x69\x72\x65\x63\x74\x6F\x72\x79\x41\x66\x74\x65\x72\x54\x65\x73\x74\x52\x75\x6E\x49\x73\x43\x6F\x6D\x70\x6C\x65\x74\x65\x3E\n\x20\x20\x20\x20\x3C\x44\x65\x70\x6C\x6F\x79\x6D\x65\x6E\x74\x45\x6E\x61\x62\x6C\x65\x64\x3E\x46\x61\x6C\x73\x65\x3C\x2F\x44\x65\x70\x6C\x6F\x79\x6D\x65\x6E\x74\x45\x6E\x61\x62\x6C\x65\x64\x3E\n\x20\x20\x3C\x2F\x4D\x53\x54\x65\x73\x74\x3E\n\x3C\x2F\x52\x75\x6E\x53\x65\x74\x74\x69\x6E\x67\x73\x3E"
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: testrunsettings


---

apiVersion: batch/v1
kind: Job
metadata:
  name: test-run-app
spec:
  ttlSecondsAfterFinished: 600      # __AUTOTESTMATE_TTLSECONDSAFTERFINISHED__ # seconds
  template:
    metadata:
      labels:
        app: test-run-app
    spec:
      containers:
        - name: test-run-app
          image: alex2357/testrunpoc    # __AUTOTESTMATE_FULL_IMAGE_NAME__ # autotestmate-samples:latest
          imagePullPolicy: IfNotPresent
          command: [ "/bin/sh", "-c",  "dotnet test /app/AutoTestMate.Calculator.Tests.dll --Settings:testsettings.runsettings"]
          env:
            - name: TestIterationCount
              value: "1"    # "__TEST_ITERATION_COUNT__"
          # resources:
          #   requests:
          #     cpu: "__AUTOTESTMATE_REQUESTS_CPU__"
          #     memory: "__AUTOTESTMATE_REQUESTS_MEMORY__"
          #   limits:
          #     cpu: "__AUTOTESTMATE_LIMITS_CPU__"
          #     memory: "__AUTOTESTMATE_LIMITS_MEMORY__"
          # imagePullPolicy: Always
          volumeMounts:
            - mountPath: /app/testsettings.runsettings
              name: cfgmaptrs
              subPath: k8s-runsettings
      volumes:
        - name: cfgmaptrs
          configMap:
            name: testrunsettings

      restartPolicy: OnFailure
  backoffLimit: 0   # default 6, 0 to no restart
  completions: 4    # __AUTOTESTMATE_REPLICAS__
  parallelism: 4    #__AUTOTESTMATE_PARALLELISM__